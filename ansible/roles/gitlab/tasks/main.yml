- name: Install dependencies
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - apt-transport-https
    state: present
    update_cache: true

- name: Download GitLab repository setup script
  ansible.builtin.get_url:
    url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
    dest: /tmp/gitlab-repo-setup.sh
    mode: '0755'

- name: Run GitLab repository setup script
  ansible.builtin.command: /tmp/gitlab-repo-setup.sh
  args:
    creates: /etc/apt/sources.list.d/gitlab_gitlab-ce.list

- name: Install GitLab CE
  ansible.builtin.apt:
    name: gitlab-ce
    state: present
    update_cache: true
  environment:
    EXTERNAL_URL: "{{ gitlab_external_url }}"
